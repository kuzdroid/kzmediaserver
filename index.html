<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KZMedia • Tek Dosya (Yerel Demo)</title>
<style>
:root{--bg:#0b0c10;--card:#11131a;--text:#e8eaed;--muted:#a3a7b0;--primary:#4f8cff;--accent:#64d2ff;--danger:#ff5c74;--border:#212532}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.container{grid-template-columns:1fr 360px}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1016;color:var(--text);outline:none}
button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.small{font-size:13px;color:var(--muted)}
.feed .post{margin-top:12px;padding:12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.post .meta{display:flex;justify-content:space-between;align-items:center}
.post img,.post video{max-width:100%;border-radius:8px;margin-top:8px}
.tag{background:var(--primary);color:#fff;padding:3px 8px;border-radius:999px;font-size:12px;margin-left:8px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.notice{padding:8px;border-radius:8px;background:#122;color:#9fdf;margin-top:8px}
.admin-badge{background:#222;border-radius:6px;padding:4px 8px;font-size:12px;color:var(--accent)}
.row{display:flex;gap:8px;align-items:center;margin-top:6px}
.field-inline{flex:1}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
.small-muted{font-size:12px;color:var(--muted)}
.user-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px dashed var(--border)}
.user-row:first-child{border-top:none}
.user-row .left{display:flex;gap:8px;align-items:center}
.user-row button{padding:6px 8px;font-size:13px}
.inline-small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="header">
  <div style="font-weight:800">KZMedia</div>
  <div class="small-muted">Yerel demo — veriler localStorage'da. (Örnek kullanıcılar hazır)</div>
</div>

<main class="container">
  <!-- Sol: Akış ve Paylaşım -->
  <section class="card">
    <div id="topArea">
      <div id="authBox">
        <h3>Giriş / Kayıt</h3>
        <div class="row">
          <input id="txtUser" placeholder="Kullanıcı adı (ör. kursatomer@KUZİLER)" class="field-inline">
          <input id="txtPass" placeholder="Şifre" class="field-inline" type="password">
        </div>
        <div class="row">
          <button id="btnRegister" class="btn-primary">Kayıt Ol</button>
          <button id="btnLogin">Giriş</button>
        </div>
        <div class="small-muted" style="margin-top:8px">Sistemde hazır kullanıcılar var: kursatomer@KUZİLER, elalye@KUZİLER, sena@KUZİLER, MR.Selim@KUZİLER</div>
      </div>

      <div id="composeBox" style="display:none;margin-top:12px">
        <h3>Paylaş</h3>
        <textarea id="postText" rows="3" placeholder="Ne paylaşmak istersin?"></textarea>
        <input id="postImage" placeholder="Resim URL (opsiyonel)">
        <input id="postVideo" placeholder="Video URL (opsiyonel)">
        <label style="display:block;margin-top:6px"><input id="postPrivate" type="checkbox"> <span class="small">@kuzilerözel (yalnızca @KUZİLER üyeleri görebilir)</span></label>
        <div class="controls">
          <button id="btnPost" class="btn-primary">Paylaş</button>
          <button id="btnRefresh">Yenile</button>
        </div>
      </div>
    </div>

    <hr>
    <h3>Akış</h3>
    <div id="feed" class="feed"></div>
    <div id="empty" class="notice" style="display:none">Henüz gönderi yok.</div>
    <div class="footer">KZMedia • Yerel demo</div>
  </section>

  <!-- Sağ: Profil / Admin / Yönetim -->
  <aside class="card">
    <div>
      <div class="small">Şu anki kullanıcı: <strong id="meName">—</strong> <span id="meBadge"></span></div>
      <div class="small-muted" style="margin-top:6px">Takipçi: <strong id="meFollowers">0</strong></div>
      <div style="margin-top:8px" id="authButtons"></div>
    </div>

    <hr>

    <div>
      <h4>Arama / Filtre</h4>
      <input id="q" placeholder="Metinde ara...">
      <div class="row" style="margin-top:8px">
        <button id="btnSearch">Ara</button>
        <button id="btnClear" style="margin-left:8px">Temizle</button>
      </div>
    </div>

    <hr>

    <div id="adminPanel" style="display:none">
      <h4>Admin Paneli</h4>
      <div class="small-muted">Sadece ADMIN görüyor. Kursatomer özel yetkilere sahip (troll avantajları).</div>

      <div style="margin-top:8px">
        <label>Duyuru / İlan (tek tane)</label>
        <textarea id="adminAd" rows="3" placeholder="Kısa ilan/duyuru"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnSaveAd" class="btn-primary">Duyuruyu Kaydet</button>
          <button id="btnClearAd">Temizle</button>
        </div>
      </div>

      <hr>

      <div>
        <h4>Kullanıcıları Yönet</h4>
        <div id="userList"></div>
      </div>

      <hr>

      <div>
        <label>Kullanıcı takipçi sayısını değiştir</label>
        <div class="row" style="margin-top:6px">
          <input id="adminUserFollowers" placeholder="kullaniciadi@KUZİLER" class="field-inline">
          <input id="adminFollowerCount" placeholder="yeni sayı (ör. 42 veya ∞ için INF)" style="width:90px">
        </div>
        <div style="margin-top:8px">
          <button id="btnSetFollowers" class="btn-primary">Uygula</button>
        </div>
      </div>
    </div>

    <div id="adBox" style="margin-top:12px"></div>
  </aside>
</main>

<script>
/* === Backend adapter (IP-like/follow; senin düzen korunuyor) === */
const API = ""; // aynı origin. Ayrı domain ise buraya tam URL yaz.
const $ = (id)=>document.getElementById(id);

function setToken(t){ if(!t){localStorage.removeItem("kz_tok");} else {localStorage.setItem("kz_tok",t);} }
function getToken(){ return localStorage.getItem("kz_tok"); }
function auth(){ const t=getToken(); return t? {Authorization:"Bearer "+t}:{ }; }
function esc(s=""){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]); }

function showAuth(on){
  document.getElementById('composeBox').style.display = on ? 'block' : 'none';
  document.getElementById('authBox').style.display    = on ? 'none'  : 'block';
}
function setMeHeader(me){
  document.getElementById('meName').textContent = me?.username || '—';
  document.getElementById('meFollowers').textContent = me?.followers ?? 0;
  document.getElementById('meBadge').innerHTML = Array.isArray(me?.roles) && me.roles.includes('ADMIN')
    ? '<span class="admin-badge">ADMIN</span>'
    : (Array.isArray(me?.roles) && me.roles.includes('KUZILER') ? '<span class="small-muted">@KUZILER</span>' : '');
  document.getElementById('adminPanel').style.display =
    (Array.isArray(me?.roles) && me.roles.includes('ADMIN')) ? 'block' : 'none';
}

/* --- Auth --- */
document.getElementById('btnRegister').addEventListener('click', async ()=>{
  const username = document.getElementById('txtUser').value.trim();
  const password = document.getElementById('txtPass').value;
  if(!username || !password) return alert("Kullanıcı ve şifre gerekli");
  const ownerCode = (password==='0') ? '0' : ''; // 0 → ADMIN+KUZILER
  const r = await fetch(API+'/api/auth/register',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username,email:`${username}@kz.local`,password,ownerCode})
  });
  const out = await r.json();
  if(!r.ok) return alert(out.error||'Kayıt başarısız');
  alert('Kayıt tamam. Şimdi giriş yap.');
});

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const u = document.getElementById('txtUser').value.trim();
  const p = document.getElementById('txtPass').value;
  const r = await fetch(API+'/api/auth/login',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({usernameOrEmail:u,password:p})
  });
  const out = await r.json();
  if(!r.ok) return alert(out.error||'Giriş başarısız');
  setToken(out.token);
  showAuth(true);
  setMeHeader(out.user);
  addAuthButtons(out.user);
  await loadFeed();
});

function addAuthButtons(me){
  const box=document.getElementById('authButtons'); box.innerHTML='';
  if(me){
    const b1=document.createElement('button'); b1.textContent='Profilim';
    b1.onclick=()=>alert('Profil: '+(me.username||'—'));
    const b2=document.createElement('button'); b2.textContent='Çıkış';
    b2.onclick=()=>{ setToken(''); showAuth(false); document.getElementById('feed').innerHTML=''; document.getElementById('empty').style.display='block'; };
    box.appendChild(b1); box.appendChild(b2);
  }
}

/* --- Paylaş --- */
document.getElementById('btnPost').addEventListener('click', async ()=>{
  if(!getToken()) return alert('Önce giriş yap');
  const text = document.getElementById('postText').value.trim();
  const imageUrl = document.getElementById('postImage').value.trim();
  const videoUrl = document.getElementById('postVideo').value.trim();
  const isPrivate = document.getElementById('postPrivate').checked;
  if(!text) return alert('Metin boş olamaz');
  const r = await fetch(API+'/api/posts',{
    method:'POST',
    headers:{'Content-Type':'application/json',...auth()},
    body:JSON.stringify({text,imageUrl,videoUrl,private:isPrivate})
  });
  const out = await r.json();
  if(!r.ok) return alert(out.error||'Paylaşım başarısız');
  document.getElementById('postText').value=''; document.getElementById('postImage').value='';
  document.getElementById('postVideo').value=''; document.getElementById('postPrivate').checked=false;
  await loadFeed();
});

/* --- Feed --- */
document.getElementById('btnRefresh').addEventListener('click', ()=>loadFeed());
document.getElementById('btnSearch').addEventListener('click', ()=>loadFeed());
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('q').value=''; loadFeed();
});

async function loadFeed(){
  const feed = document.getElementById('feed'); feed.innerHTML='';
  const empty = document.getElementById('empty');
  if(!getToken()){ empty.style.display='block'; empty.textContent='Giriş yapınca akış gözükecek.'; return; }

  const r = await fetch(API+'/api/posts/feed?limit=50',{ headers:{...auth()} });
  const arr = await r.json();
  if(!r.ok){ empty.style.display='block'; empty.textContent = (arr.error||'Akış hatası'); return; }

  const q = document.getElementById('q').value.trim().toLowerCase();
  let shown=0;
  for(const p of arr){
    if(q && !((p.text||'').toLowerCase().includes(q) || (p.author?.username||'').toLowerCase().includes(q))) continue;

    const who = p.author?.username || '—';
    const roles = p.author?.roles || [];
    const tag = roles.includes('KUZILER') ? '<span class="tag">@KUZILER</span>' : '';
    const when = p.createdAt ? new Date(p.createdAt).toLocaleString() : '';
    const likeCount = (typeof p.likesCount === 'number') ? p.likesCount : 0;

    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <div class="meta"><div class="who">${esc(who)} ${tag}</div><div class="small">${when}</div></div>
      <div>${esc(p.text||'')}</div>
      ${p.imageUrl?`<div><img src="${esc(p.imageUrl)}" alt=""></div>`:''}
      ${p.videoUrl?`<div><video controls src="${esc(p.videoUrl)}"></video></div>`:''}
      <div style="margin-top:8px" class="row">
        <button class="btn-like">❤ <span class="lk">${likeCount}</span></button>
        <button class="btn-follow">Takip et</button>
        <span class="small-muted">@${esc(who)}</span>
      </div>
    `;

    // LIKE (IP toggle)
    div.querySelector('.btn-like').addEventListener('click', async ()=>{
      const rr = await fetch(API+`/api/posts/${p._id}/like`,{ method:'POST' });
      const o  = await rr.json();
      if(!rr.ok) return alert(o.error||'Like hatası');
      div.querySelector('.lk').textContent = o.likes;
    });

    // FOLLOW (IP toggle) — gönderi sahibini hedefler
    div.querySelector('.btn-follow').addEventListener('click', async ()=>{
      if(!p.author?.username) return alert('Kullanıcı yok');
      const rr = await fetch(API+`/api/users/${encodeURIComponent(p.author.username)}/follow`,{ method:'POST' });
      const o  = await rr.json();
      if(!rr.ok) return alert(o.error||'Takip hatası');
      div.querySelector('.btn-follow').textContent = o.following ? 'Takipten çık' : 'Takip et';
      // sağ panelde kendi profilinse istersen /api/auth/me çekip sayıyı tazele
    });

    feed.appendChild(div); shown++;
  }
  empty.style.display = shown ? 'none' : 'block';
}

/* --- Admin UI (yalnız görsel) --- */
function renderAd(){
  const box = document.getElementById('adBox'); box.innerHTML='';
  const val = document.getElementById('adminAd')?.value?.trim();
  if(val){ const d=document.createElement('div'); d.className='notice'; d.textContent=val; box.appendChild(d); }
}
function checkAdmin(){ return true; }
document.getElementById('btnSaveAd').addEventListener('click', ()=>{ if(!checkAdmin()) return; renderAd(); alert('Duyuru gösterildi (UI)'); });
document.getElementById('btnClearAd').addEventListener('click', ()=>{ document.getElementById('adminAd').value=''; renderAd(); });

/* --- İlk yükleme --- */
(async ()=>{
  if(getToken()){
    try{
      const r = await fetch(API+'/api/auth/me',{ headers:{...auth()} });
      if(r.ok){
        const me = await r.json();
        setMeHeader(me);
        addAuthButtons(me);
        showAuth(true);
        await loadFeed();
        return;
      }
    }catch(_){}
  }
  showAuth(false);
})();
</script>
</body>
</html>
