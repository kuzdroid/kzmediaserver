<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KZMedia • Tek Dosya (Yerel Demo)</title>
<style>
:root{--bg:#0b0c10;--card:#11131a;--text:#e8eaed;--muted:#a3a7b0;--primary:#4f8cff;--accent:#64d2ff;--danger:#ff5c74;--border:#212532}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.container{grid-template-columns:1fr 360px}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1016;color:var(--text);outline:none}
button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.small{font-size:13px;color:var(--muted)}
.feed .post{margin-top:12px;padding:12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.post .meta{display:flex;justify-content:space-between;align-items:center}
.post img,.post video{max-width:100%;border-radius:8px;margin-top:8px}
.tag{background:var(--primary);color:#fff;padding:3px 8px;border-radius:999px;font-size:12px;margin-left:8px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.notice{padding:8px;border-radius:8px;background:#122;color:#9fdf;margin-top:8px}
.admin-badge{background:#222;border-radius:6px;padding:4px 8px;font-size:12px;color:var(--accent)}
.row{display:flex;gap:8px;align-items:center;margin-top:6px}
.field-inline{flex:1}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
.small-muted{font-size:12px;color:var(--muted)}
.user-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px dashed var(--border)}
.user-row:first-child{border-top:none}
.user-row .left{display:flex;gap:8px;align-items:center}
.user-row button{padding:6px 8px;font-size:13px}
.inline-small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="header">
  <div style="font-weight:800">KZMedia</div>
  <div class="small-muted">Yerel demo — veriler localStorage'da. (Örnek kullanıcılar hazır)</div>
</div>

<main class="container">
  <!-- Sol: Akış ve Paylaşım -->
  <section class="card">
    <div id="topArea">
      <div id="authBox">
        <h3>Giriş / Kayıt</h3>
        <div class="row">
          <input id="txtUser" placeholder="Kullanıcı adı (ör. kursatomer@KUZİLER)" class="field-inline">
          <input id="txtPass" placeholder="Şifre" class="field-inline" type="password">
        </div>
        <div class="row">
          <button id="btnRegister" class="btn-primary">Kayıt Ol</button>
          <button id="btnLogin">Giriş</button>
        </div>
        <div class="small-muted" style="margin-top:8px">Sistemde hazır kullanıcılar var: kursatomer@KUZİLER, elalye@KUZİLER, sena@KUZİLER, MR.Selim@KUZİLER</div>
      </div>

      <div id="composeBox" style="display:none;margin-top:12px">
        <h3>Paylaş</h3>
        <textarea id="postText" rows="3" placeholder="Ne paylaşmak istersin?"></textarea>
        <input id="postImage" placeholder="Resim URL (opsiyonel)">
        <input id="postVideo" placeholder="Video URL (opsiyonel)">
        <label style="display:block;margin-top:6px"><input id="postPrivate" type="checkbox"> <span class="small">@kuzilerözel (yalnızca @KUZİLER üyeleri görebilir)</span></label>
        <div class="controls">
          <button id="btnPost" class="btn-primary">Paylaş</button>
          <button id="btnRefresh">Yenile</button>
        </div>
      </div>
    </div>

    <hr>
    <h3>Akış</h3>
    <div id="feed" class="feed"></div>
    <div id="empty" class="notice" style="display:none">Henüz gönderi yok.</div>
    <div class="footer">KZMedia • Yerel demo</div>
  </section>

  <!-- Sağ: Profil / Admin / Yönetim -->
  <aside class="card">
    <div>
      <div class="small">Şu anki kullanıcı: <strong id="meName">—</strong> <span id="meBadge"></span></div>
      <div class="small-muted" style="margin-top:6px">Takipçi: <strong id="meFollowers">0</strong></div>
      <div style="margin-top:8px" id="authButtons"></div>
    </div>

    <hr>

    <div>
      <h4>Arama / Filtre</h4>
      <input id="q" placeholder="Metinde ara...">
      <div class="row" style="margin-top:8px">
        <button id="btnSearch">Ara</button>
        <button id="btnClear" style="margin-left:8px">Temizle</button>
      </div>
    </div>

    <hr>

    <div id="adminPanel" style="display:none">
      <h4>Admin Paneli</h4>
      <div class="small-muted">Sadece ADMIN görüyor. Kursatomer özel yetkilere sahip (troll avantajları).</div>

      <div style="margin-top:8px">
        <label>Duyuru / İlan (tek tane)</label>
        <textarea id="adminAd" rows="3" placeholder="Kısa ilan/duyuru"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnSaveAd" class="btn-primary">Duyuruyu Kaydet</button>
          <button id="btnClearAd">Temizle</button>
        </div>
      </div>

      <hr>

      <div>
        <h4>Kullanıcıları Yönet</h4>
        <div id="userList"></div>
      </div>

      <hr>

      <div>
        <label>Kullanıcı takipçi sayısını değiştir</label>
        <div class="row" style="margin-top:6px">
          <input id="adminUserFollowers" placeholder="kullaniciadi@KUZİLER" class="field-inline">
          <input id="adminFollowerCount" placeholder="yeni sayı (ör. 42 veya ∞ için INF)" style="width:90px">
        </div>
        <div style="margin-top:8px">
          <button id="btnSetFollowers" class="btn-primary">Uygula</button>
        </div>
      </div>
    </div>

    <div id="adBox" style="margin-top:12px"></div>
  </aside>
</main>

<script>
/*
  Tek dosya KZMedia — güncellenmiş.
  Hazır kullanıcılar (kullanici:şifre):
    - kursatomer@KUZİLER  : KUZİLER    (ADMIN, troll avantajları, followers = Infinity)
    - elalye@KUZİLER      : KZTeknik   (KUZILER member)
    - sena@KUZİLER        : KZResim    (KUZILER member)
    - MR.Selim@KUZİLER    : KZYTB      (KUZILER member)

  Not: localStorage anahtarı = 'KZMedia.data'
*/

const OWNER_CODE = "0"; // istersen owner kodunu kullanabilirsin (kayıt için)
const INF = "∞";

let DATA = loadData();
const $ = id => document.getElementById(id);

// Eğer başlangıçta kullanıcılar yoksa hazırla
(function ensureDefaults(){
  if(!DATA.users) DATA.users = {};
  // add default users if not exist
  const defaults = {
    "kursatomer@KUZİLER": { pass: "KUZİLER", roles: ["ADMIN","KUZILER"], followers: Infinity },
    "elalye@KUZİLER":     { pass: "KZTeknik", roles: ["KUZILER"], followers: 100 },
    "sena@KUZİLER":       { pass: "KZResim", roles: ["KUZILER"], followers: 80 },
    "MR.Selim@KUZİLER":   { pass: "KZYTB", roles: ["KUZILER"], followers: 50 }
  };
  for(const k in defaults){
    if(!DATA.users[k]) DATA.users[k] = defaults[k];
  }
  if(!DATA.posts) DATA.posts = [];
  if(DATA.ad===undefined) DATA.ad = "";
  saveData();
})();

function loadData(){
  const raw = localStorage.getItem('KZMedia.data');
  if(!raw) return { users:{}, posts:[], ad:"" };
  try{ return JSON.parse(raw); }catch(e){ return { users:{}, posts:[], ad:"" }; }
}
function saveData(){ localStorage.setItem('KZMedia.data', JSON.stringify(DATA)); }

function setMe(name){
  if(!name){
    window._ME = null;
    $('meName').textContent = '—';
    $('meBadge').textContent = '';
    $('meFollowers').textContent = '0';
  } else {
    window._ME = { name };
    const u = DATA.users[name];
    const isAdmin = u.roles && u.roles.indexOf('ADMIN')>=0;
    const isK = u.roles && u.roles.indexOf('KUZILER')>=0;
    $('meName').textContent = name;
    $('meBadge').innerHTML = isAdmin ? '<span class="admin-badge">ADMIN</span>' : (isK ? '<span class="small-muted">@KUZILER</span>' : '');
    const f = u.followers === Infinity ? INF : (u.followers || 0);
    $('meFollowers').textContent = f;
  }
  renderAuthUI();
  loadFeed();
  renderAd();
  addAuthButtons();
  renderUsers();
}

function renderAuthUI(){
  if(window._ME){ $('composeBox').style.display='block'; $('authBox').style.display='none'; }
  else { $('composeBox').style.display='none'; $('authBox').style.display='block'; }

  const meName = window._ME?.name;
  if(meName && DATA.users[meName] && DATA.users[meName].roles && DATA.users[meName].roles.indexOf('ADMIN')>=0){
    $('adminPanel').style.display='block';
  } else {
    $('adminPanel').style.display='none';
  }
}

// Register / Login
$('btnRegister').addEventListener('click', ()=>{
  const name = $('txtUser').value.trim();
  const pass = $('txtPass').value;
  if(!name){ alert('Kullanıcı adı girin'); return; }
  if(DATA.users[name]){ alert('Bu kullanıcı adı zaten var'); return; }
  DATA.users[name] = { pass: pass||'', roles: [], followers: 0 };
  // owner kodu ile ilk kayıt admin olabilir
  if(pass === OWNER_CODE){ DATA.users[name].roles.push('ADMIN'); DATA.users[name].roles.push('KUZILER'); }
  saveData();
  alert('Kayıt tamam. Giriş yapabilirsiniz.');
});

$('btnLogin').addEventListener('click', ()=>{
  const name = $('txtUser').value.trim();
  const pass = $('txtPass').value;
  if(!name){ alert('Kullanıcı adı girin'); return; }
  const u = DATA.users[name];
  if(!u){ alert('Kullanıcı bulunamadı. Kayıt olun.'); return; }
  if(u.pass !== pass){ alert('Şifre yanlış'); return; }
  setMe(name);
});

// logout / profile buttons
function addAuthButtons(){
  const box = $('authButtons'); box.innerHTML = '';
  if(window._ME){
    const btnProfile = document.createElement('button'); btnProfile.textContent = 'Profilim';
    btnProfile.onclick = ()=> alert('Profil: ' + window._ME.name);
    const btnLogout = document.createElement('button'); btnLogout.textContent = 'Çıkış';
    btnLogout.onclick = ()=> setMe(null);
    box.appendChild(btnProfile); box.appendChild(btnLogout);
  }
}

// Posts
$('btnPost').addEventListener('click', ()=>{
  if(!window._ME){ alert('Önce giriş yapın'); return; }
  const text = $('postText').value.trim();
  if(!text){ alert('Metin boş olamaz'); return; }
  const p = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,8),
    author: window._ME.name,
    text,
    imageUrl: $('postImage').value.trim() || null,
    videoUrl: $('postVideo').value.trim() || null,
    private: !!$('postPrivate').checked,
    likes: 0,
    createdAt: Date.now()
  };
  DATA.posts.push(p);
  saveData();
  $('postText').value=''; $('postImage').value=''; $('postVideo').value=''; $('postPrivate').checked=false;
  loadFeed();
});

function loadFeed(){
  const feed = $('feed'); feed.innerHTML = '';
  const q = $('q')?.value.trim().toLowerCase() || '';
  const list = (DATA.posts||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  let shown = 0;
  for(const p of list){
    if(p.private){
      const me = window._ME ? DATA.users[window._ME.name] : null;
      const isMember = me && me.roles && me.roles.indexOf('KUZILER')>=0;
      if(!isMember && !(window._ME && window._ME.name === p.author)) continue;
    }
    if(q && !((p.text||'').toLowerCase().includes(q) || (p.author||'').toLowerCase().includes(q))) continue;
    const div = document.createElement('div'); div.className = 'post';
    const isAdmin = window._ME && DATA.users[window._ME.name] && DATA.users[window._ME.name].roles && DATA.users[window._ME.name].roles.indexOf('ADMIN')>=0;
    const canEdit = window._ME && (window._ME.name === p.author || isAdmin);
    const tag = (DATA.users[p.author] && DATA.users[p.author].roles && DATA.users[p.author].roles.indexOf('KUZILER')>=0) ? '<span class="tag">@KUZILER</span>' : '';
    div.innerHTML = `<div class="meta"><div class="who">${escapeHtml(p.author)} ${tag}</div><div class="small">${new Date(p.createdAt).toLocaleString()}</div></div>
                     <div>${escapeHtml(p.text)}</div>
                     ${p.imageUrl?`<div><img src="${escapeHtml(p.imageUrl)}" alt=""></div>`:''}
                     ${p.videoUrl?`<div><video controls src="${escapeHtml(p.videoUrl)}"></video></div>`:''}
                     <div style="margin-top:8px" class="row">
                       <button class="btn-like">❤ ${p.likes||0}</button>
                       ${canEdit?'<button class="btn-edit">Düzenle</button>':''}
                       ${canEdit?'<button class="btn-del">Sil</button>':''}
                     </div>`;
    feed.appendChild(div);
    shown++;
    div.querySelector('.btn-like')?.addEventListener('click', ()=>{ p.likes=(p.likes||0)+1; saveData(); loadFeed(); });
    if(canEdit){
      div.querySelector('.btn-edit')?.addEventListener('click', ()=>{ 
        // kursatomer special: can edit anyone's post; other admins can too
        if(!(window._ME && (window._ME.name === p.author || (DATA.users[window._ME.name] && DATA.users[window._ME.name].roles.indexOf('ADMIN')>=0)))) return;
        const newText = prompt('Yeni metin:', p.text);
        if(newText !== null){ p.text = newText; saveData(); loadFeed(); }
      });
      div.querySelector('.btn-del')?.addEventListener('click', ()=>{ 
        if(!(window._ME && (window._ME.name === p.author || (DATA.users[window._ME.name] && DATA.users[window._ME.name].roles.indexOf('ADMIN')>=0)))) return;
        if(confirm('Gönderiyi silmek istiyor musunuz?')){ DATA.posts = DATA.posts.filter(x=>x.id!==p.id); saveData(); loadFeed(); }
      });
    }
  }
  $('empty').style.display = shown ? 'none' : 'block';
}

function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

// Admin actions
$('btnSaveAd')?.addEventListener('click', ()=>{ if(!checkAdmin()) return; DATA.ad = $('adminAd').value.trim(); saveData(); renderAd(); alert('Duyuru kaydedildi'); });
$('btnClearAd')?.addEventListener('click', ()=>{ if(!checkAdmin()) return; DATA.ad = ''; saveData(); renderAd(); });

$('btnSetFollowers')?.addEventListener('click', ()=>{
  if(!checkAdmin()) return;
  const name = $('adminUserFollowers').value.trim();
  let cntRaw = $('adminFollowerCount').value.trim();
  if(!name || !DATA.users[name]) return alert('Kullanıcı bulunamadı');
  if(cntRaw === '∞' || cntRaw.toUpperCase()==='INF') {
    DATA.users[name].followers = Infinity;
  } else {
    const cnt = parseInt(cntRaw);
    if(Number.isNaN(cnt)) return alert('Geçerli sayı girin');
    DATA.users[name].followers = cnt;
  }
  saveData();
  alert('Ayar kaydedildi');
  if(window._ME && window._ME.name === name) setMe(name);
});

// render ad
function renderAd(){ const box = $('adBox'); box.innerHTML=''; if(DATA.ad && DATA.ad.trim()){ const d = document.createElement('div'); d.className='notice'; d.textContent = DATA.ad; box.appendChild(d); } }

// check admin
function checkAdmin(){ const me = window._ME && DATA.users[window._ME.name]; if(!me || !me.roles || me.roles.indexOf('ADMIN')<0){ alert('Sadece adminler yapabilir'); return false; } return true; }

// render users list in admin panel
function renderUsers(){
  const list = $('userList'); if(!list) return; list.innerHTML = '';
  // show users sorted: admins first
  const names = Object.keys(DATA.users).sort((a,b)=>{
    const aAdmin = DATA.users[a].roles && DATA.users[a].roles.indexOf('ADMIN')>=0;
    const bAdmin = DATA.users[b].roles && DATA.users[b].roles.indexOf('ADMIN')>=0;
    return (aAdmin === bAdmin) ? a.localeCompare(b) : (aAdmin ? -1 : 1);
  });
  for(const name of names){
    const u = DATA.users[name];
    const div = document.createElement('div'); div.className='user-row';
    const left = document.createElement('div'); left.className='left';
    const badge = (u.roles && u.roles.indexOf('ADMIN')>=0) ? '<span class="admin-badge">ADMIN</span>' : ((u.roles && u.roles.indexOf('KUZILER')>=0)?'<span class="small-muted">@KUZILER</span>':'');
    const f = u.followers === Infinity ? INF : (u.followers||0);
    left.innerHTML = `<div><strong>${name}</strong> ${badge} <div class="inline-small">Takipçi: ${f}</div></div>`;
    const right = document.createElement('div');
    // Make Admin button (visible to admins)
    const btnMakeAdmin = document.createElement('button'); btnMakeAdmin.textContent = 'Admin Yap'; btnMakeAdmin.className='btn-primary';
    btnMakeAdmin.onclick = ()=>{
      if(!checkAdmin()) return;
      if(!u.roles) u.roles = [];
      if(u.roles.indexOf('ADMIN')<0) u.roles.push('ADMIN');
      if(u.roles.indexOf('KUZILER')<0) u.roles.push('KUZILER');
      saveData(); renderUsers(); alert(name + ' artık ADMIN!');
    };
    // Set followers button
    const btnSetF = document.createElement('button'); btnSetF.textContent = 'Takipçi Ayarla'; btnSetF.onclick = ()=>{
      if(!checkAdmin()) return;
      // kursatomer special: can directly set infinite
      let cur = prompt('Yeni takipçi sayısı (yaz "INF" veya "∞" için sonsuz):', u.followers===Infinity? 'INF' : (u.followers||0));
      if(cur === null) return;
      if(cur === '∞' || cur.toUpperCase()==='INF'){ u.followers = Infinity; }
      else { const n = parseInt(cur); if(Number.isNaN(n)) return alert('Geçerli sayı girin'); u.followers = n; }
      saveData(); renderUsers();
    };
    // Troll action: kursatomer özel (ör: troll => takipçi INF + gösterme mesajı)
    const btnTroll = document.createElement('button'); btnTroll.textContent = 'TROLL'; btnTroll.className='btn-danger';
    btnTroll.onclick = ()=>{
      // only kursatomer can use "TROLL"
      if(!(window._ME && window._ME.name === 'kursatomer@KUZİLER')){ alert('Sadece kursatomer kullanabilir'); return; }
      if(!confirm(name + ' kullanıcısına troll işlemi uygula (takipçi => ∞ ve "trollled" notu ekle)?')) return;
      u.followers = Infinity;
      // ek opsiyon: kullanıcının adını değiştirme yerine suffix ekle (zaten suffix var)
      // istersen not ekle
      if(!u.meta) u.meta = {};
      u.meta.trolledAt = Date.now();
      saveData(); renderUsers(); alert(name + ' trollledi (takipçi ∞ oldu).');
    };

    // If current user is kursatomer or any admin, show Make Admin button; but kursatomer can make admin always (already admin)
    right.appendChild(btnMakeAdmin);
    right.appendChild(btnSetF);
    // show troll button only if current logged in is kursatomer
    if(window._ME && window._ME.name === 'kursatomer@KUZİLER') right.appendChild(btnTroll);
    div.appendChild(left); div.appendChild(right);
    list.appendChild(div);
  }
}

// Payment-request / IBAN flow could be added separately (manual).
// Admin onay is done via this UI (Make Admin button).

// --- Misc UI handlers
$('btnSearch')?.addEventListener('click', ()=>loadFeed());
$('btnClear')?.addEventListener('click', ()=>{ $('q').value=''; loadFeed(); });
$('btnRefresh')?.addEventListener('click', ()=>loadFeed());

// Auto-save / startup
(function startup(){
  saveData();
  setMe(null);
  loadFeed();
})();
// KZMedia - Prod Backend (tek MONGO_URL ile; JWT_KEY dahili; teşhis endpoint'li)
const express = require("express");
const mongoose = require("mongoose");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const helmet = require("helmet");
const cors = require("cors");
const rateLimit = require("express-rate-limit");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 8080;

// JWT_KEY: İstersen ENV'den gelir, yoksa alttaki güçlü varsayılan kullanılır.
const JWT_KEY = (process.env.JWT_KEY || "kzmedia_prod_" +
  "f2d8c7f9c0a14a5ab2c4b8e9d1e3f5a7b9c2d4e6f8a0b1c2d3e4f5061728394").slice(0, 64);

const DB_NAME = process.env.DB_NAME || "kzmedia";

app.set("trust proxy", 1);
app.use(helmet({ contentSecurityPolicy: false }));
app.use(cors());
app.use(express.json({ limit: "1mb" }));

const authLimiter = rateLimit({ windowMs: 10 * 60 * 1000, max: 60 });
const apiLimiter  = rateLimit({ windowMs: 60 * 1000, max: 120 });
app.use("/api/auth", authLimiter);
app.use("/api", apiLimiter);

/* ----------------------- MONGO URL FIXER + CONNECT ----------------------- */
function fixMongoUrl(raw) {
  if (!raw) return "";
  let s = String(raw).trim().replace(/^["']|["']$/g, ""); // tırnakları/boşlukları temizle
  const [base, q = ""] = s.split("?");
  const params = new URLSearchParams(q);

  // boş değerli veya gereksiz parametreleri temizle
  for (const [k, v] of params.entries()) { if (!v) params.delete(k); }
  params.delete("appName");

  // zorunlular
  params.set("retryWrites", "true");
  if (!params.has("w")) params.set("w", "majority");

  const qs = params.toString();
  return qs ? `${base}?${qs}` : `${base}?retryWrites=true&w=majority`;
}

function getUrlInfo(url) {
  try {
    // mongodb+srv://USER:PASSWORD@HOST/DB?...
    const m = url.match(/^mongodb\+srv:\/\/([^:@/]+)(?::[^@]*)?@([^/]+)\/?([^?]*)/i);
    return {
      user: m?.[1] || "(yok)",
      host: m?.[2] || "(yok)",
      db: (m?.[3] || "").split("?")[0] || "(yok)"
    };
  } catch { return { user: "(?)", host: "(?)", db: "(?)" }; }
}

let mongoReady = false;
let lastMongoErr = "";

async function connectMongo() {
  try {
    const raw = process.env.MONGO_URL || "";
    if (!raw) { lastMongoErr = "MONGO_URL env yok"; console.error("❌", lastMongoErr); return; }
    const safe = fixMongoUrl(raw);

    const info = getUrlInfo(safe);
    // Kullanıcı adı ASCII olmalı (Türkçe karakter hata çıkarır)
    if (/[^ -~]/.test(info.user)) {
      lastMongoErr = "Kullanıcı adında Türkçe/özel karakter var. ASCII kullan (örn: KZMedia).";
      console.error("❌", lastMongoErr);
      return;
    }

    await mongoose.connect(safe, { dbName: DB_NAME, serverSelectionTimeoutMS: 15000 });
    console.log("✅ MongoDB Atlas bağlandı");
    mongoReady = true;
    lastMongoErr = "";
  } catch (e) {
    mongoReady = false;
    lastMongoErr = e.message;
    console.error("❌ MongoDB bağlantı hatası:", e.message);
    console.error("ℹ️ Kontrol: Atlas DB user ASCII, doğru parola, Network Access 0.0.0.0/0, host/doğru DB adı.");
  }
}

connectMongo();

/* ----------------------- DEBUG ENDPOINT'LER ----------------------- */
// Şifre sızdırmaz, sadece kim bağlanmaya çalıştığını gösterir
app.get("/debug/mongo", (req, res) => {
  const raw = process.env.MONGO_URL || "";
  const safe = fixMongoUrl(raw);
  const info = getUrlInfo(safe);
  res.json({
    ok: mongoReady,
    lastError: lastMongoErr || null,
    parsed: { user: info.user, host: info.host, db: info.db },
    hasPassword: /:\/\/[^:@/]+:[^@]+@/.test(safe), // sadece var/yok
  });
});

// Anlık tekrar bağlanmayı dener
app.get("/db/check", async (req, res) => {
  if (mongoose.connection.readyState !== 1) {
    await connectMongo();
  }
  res.json({ ok: mongoose.connection.readyState === 1, state: mongoose.connection.readyState, lastError: lastMongoErr || null });
});

/* ----------------------- MODELLER ----------------------- */
const { Schema, model } = mongoose;

const userSchema = new Schema({
  username: { type: String, unique: true, required: true, minlength: 3, maxlength: 24 },
  email:    { type: String, unique: true, sparse: true },
  passwordHash: { type: String, required: true },
  roles:   { type: [String], default: [] },  // ["ADMIN","KUZILER"]
  followers: { type: Number, default: 0 },
  meta:     { type: Object, default: {} }
}, { timestamps: true });
const User = model("User", userSchema);

const postSchema = new Schema({
  author:  { type: Schema.Types.ObjectId, ref: "User", required: true },
  text:    { type: String, required: true, maxlength: 500 },
  imageUrl:{ type: String, default: "" },
  videoUrl:{ type: String, default: "" },
  private: { type: Boolean, default: false }, // @KUZILER özel
  likes:   [{ type: Schema.Types.ObjectId, ref: "User" }]
}, { timestamps: true });
const Post = model("Post", postSchema);

/* ----------------------- YARDIMCI ----------------------- */
function signToken(userId) { return jwt.sign({ userId }, JWT_KEY, { expiresIn: "7d" }); }
function requireAuth(req, res, next) {
  const token = (req.headers.authorization || "").replace(/^Bearer\s+/i, "");
  if (!token) return res.status(401).json({ error: "Oturum gerekli" });
  try { req.userId = jwt.verify(token, JWT_KEY).userId; next(); }
  catch { return res.status(401).json({ error: "Token geçersiz" }); }
}

/* ----------------------- ROUTES ----------------------- */
app.get("/health", (req, res) => res.json({ ok: true, db: mongoReady ? "up" : "down" }));

app.post("/api/auth/register", async (req, res) => {
  if (!mongoReady) return res.status(503).json({ error: "DB hazır değil" });
  try {
    const { username, email, password, ownerCode } = req.body || {};
    if (!username || !password) return res.status(400).json({ error: "Eksik alanlar" });

    const exists = await User.findOne({ $or: [{ username }, { email }] });
    if (exists) return res.status(409).json({ error: "Kullanıcı adı veya e-posta kullanımda" });

    const passwordHash = await bcrypt.hash(password, 10);
    const roles = ownerCode === "0" ? ["ADMIN", "KUZILER"] : [];
    const user = await User.create({ username, email, passwordHash, roles });
    res.status(201).json({ id: user._id, username: user.username, roles: user.roles });
  } catch (e) { res.status(500).json({ error: e.message }); }
});
app.post("/api/auth/login", async (req, res) => {
  if (!mongoReady) return res.status(503).json({ error: "DB hazır değil" });
  try {
    const { usernameOrEmail, password } = req.body || {};
    const user = await User.findOne({ $or: [{ username: usernameOrEmail }, { email: usernameOrEmail }] });
    if (!user) return res.status(401).json({ error: "Kullanıcı bulunamadı" });
    const ok = await bcrypt.compare(password, user.passwordHash);
    if (!ok) return res.status(401).json({ error: "Şifre hatalı" });
    const token = signToken(user._id);
    res.json({ token, user: { id: user._id, username: user.username, roles: user.roles, followers: user.followers } });
  } catch (e) { res.status(500).json({ error: e.message }); }
});
app.post("/api/posts", requireAuth, async (req, res) => {
  if (!mongoReady) return res.status(503).json({ error: "DB hazır değil" });
  try {
    const { text, imageUrl, videoUrl, private: isPrivate } = req.body || {};
    if (!text || !String(text).trim()) return res.status(400).json({ error: "Metin gerekli" });
    const post = await Post.create({ author: req.userId, text: String(text).trim(), imageUrl: imageUrl||"", videoUrl: videoUrl||"", private: !!isPrivate });
    const populated = await post.populate("author", "username roles");
    res.status(201).json(populated);
  } catch (e) { res.status(500).json({ error: e.message }); }
});
app.get("/api/posts/feed", requireAuth, async (req, res) => {
  if (!mongoReady) return res.status(503).json({ error: "DB hazır değil" });
  const limit = Math.min(parseInt(req.query.limit) || 50, 100);
  const posts = await Post.find().sort({ createdAt: -1 }).limit(limit).populate("author", "username roles");
  res.json(posts);
});
// Statik index.html (senin dosyan)
app.get("/", (req, res) => { res.sendFile(path.join(__dirname, "index.html")); });
app.listen(PORT, "0.0.0.0", () => { console.log(`🚀 KZMedia API ayakta: http://localhost:${PORT}`); });
</script>
</body>
</html>
