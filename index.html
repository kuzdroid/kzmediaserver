<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KZMedia â€¢ AkÄ±ÅŸ + KZAsistan</title>
<style>
  :root{--bg:#0b0c10;--card:#11131a;--text:#e8eaed;--muted:#a3a7b0;--primary:#4f8cff;--border:#212532}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
  .container{max-width:1080px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr 340px;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1016;color:var(--text);outline:none}
  button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--primary);color:#fff}
  .row{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .post{margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:10px}
  #progress{width:100%;background:#222;border-radius:6px;overflow:hidden;height:8px;margin-top:8px}
  #progressBar{height:100%;background:var(--primary);width:0%}
</style>
</head>
<body>
<header class="header">
  <strong>KZMedia</strong>
  <span class="small">â€¢ akÄ±ÅŸ MongoDB â€¢ asistan tarayÄ±cÄ±da (Llama)</span>
</header>

<main class="container">
  <!-- Sol: GiriÅŸ/KayÄ±t (yerel), PaylaÅŸ, AkÄ±ÅŸ -->
  <section class="card">
    <h3>GiriÅŸ / KayÄ±t (Yerel)</h3>
    <div class="row">
      <input id="txtUser" placeholder="kullanÄ±cÄ± adÄ± (Ã¶r: kursatomer@KUZÄ°LER)"/>
      <input id="txtPass" type="password" placeholder="ÅŸifre (sadece yerel)"/>
      <button id="btnRegister">KayÄ±t Ol</button>
      <button id="btnLogin">GiriÅŸ</button>
    </div>
    <div class="small">Not: Bu sÃ¼rÃ¼mde kullanÄ±cÄ±lar sunucuya kaydedilmez; sadece tarayÄ±cÄ±nda tutulur.</div>

    <hr style="border-color:#212532">
    <div id="compose" style="display:none">
      <h3>PaylaÅŸ</h3>
      <textarea id="postText" rows="3" placeholder="Ne paylaÅŸmak istersin?"></textarea>
      <input id="postImage" placeholder="Resim URL (opsiyonel)"/>
      <input id="postVideo" placeholder="Video URL (opsiyonel)"/>
      <label class="row"><input id="postPrivate" type="checkbox"/><span class="small">@KUZILER (Ã¶zel iÅŸaret â€” sunucuda kontrol edilmez)</span></label>
      <div class="row">
        <button id="btnPost">PaylaÅŸ</button>
        <button id="btnRefresh">Yenile</button>
      </div>
    </div>

    <hr style="border-color:#212532">
    <div class="row">
      <input id="q" placeholder="Metinde ara..."/>
      <button id="btnSearch">Ara</button>
      <button id="btnClear">Temizle</button>
    </div>

    <h3 style="margin-top:12px">AkÄ±ÅŸ</h3>
    <div id="feed"></div>
    <div id="empty" class="small" style="display:none">GÃ¶nderi yok</div>
  </section>

  <!-- SaÄŸ: KZAsistan -->
  <aside class="card">
    <h4>KZAsistan (Llama-2-7B)</h4>
    <div id="progress"><div id="progressBar"></div></div>
    <div class="row" style="margin-top:6px">
      <input id="ask" placeholder="Soru yaz..."/>
      <button id="btnAsk">Sor</button>
    </div>
    <div id="ans" class="small" style="white-space:pre-wrap;margin-top:8px;background:#0e1016;border:1px solid #222;border-radius:8px;padding:8px;min-height:64px"></div>
    <div class="row" style="margin-top:8px">
      <button id="btnAsistanToFeed">Asistan MesajÄ±nÄ± AkÄ±ÅŸa Yaz</button>
    </div>
    <div class="small" id="httpsWarn" style="margin-top:6px;color:#ffb84d;display:none">
      âš ï¸ Modeli indirmek iÃ§in sayfanÄ±n HTTPS veya localhost Ã¼zerinden aÃ§Ä±lmasÄ± gerekir.
    </div>
  </aside>
</main>

<!-- WebLLM (kÃ¼Ã§Ã¼k CDN, global: webllm) -->
<script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.42/dist/index.min.js"></script>
<script>
  const $ = id => document.getElementById(id);
  const API = ""; // aynÄ± origin
  const store = {
    get token(){ return localStorage.getItem("kzmedia_user"); }, // sadece username
    set token(v){ localStorage.setItem("kzmedia_user", v); }
  };
  function setBar(p){ $("progressBar").style.width = Math.max(0,Math.min(100,p)) + "%"; }

  // --- KayÄ±t/GiriÅŸ (yerel) ---
  $("btnRegister").addEventListener("click", ()=>{
    const u=$("txtUser").value.trim(), p=$("txtPass").value.trim();
    if(!u||!p) return alert("KullanÄ±cÄ± adÄ± ve ÅŸifre gereklidir");
    // sadece tarayÄ±cÄ±ya koyuyoruz (gÃ¼venlik yok)
    localStorage.setItem("kzmedia_pass_"+u, p);
    alert("KayÄ±t tamam. Åimdi giriÅŸ yapÄ±n.");
  });

  $("btnLogin").addEventListener("click", ()=>{
    const u=$("txtUser").value.trim(), p=$("txtPass").value.trim();
    if(!u||!p) return alert("KullanÄ±cÄ± adÄ± ve ÅŸifre gereklidir");
    const saved = localStorage.getItem("kzmedia_pass_"+u);
    if(!saved || saved !== p) return alert("GiriÅŸ baÅŸarÄ±sÄ±z (bu sÃ¼rÃ¼m yerel doÄŸrular)");
    store.token = u; // giriÅŸ yapan adÄ±
    $("compose").style.display = "block";
    loadFeed();
  });

  // --- AkÄ±ÅŸ ---
  $("btnSearch").addEventListener("click", loadFeed);
  $("btnClear").addEventListener("click", ()=>{ $("q").value=""; loadFeed(); });
  $("btnRefresh").addEventListener("click", loadFeed);

  async function loadFeed(){
    try{
      const q = $("q").value.trim();
      const url = API + "/api/posts" + (q ? ("?q="+encodeURIComponent(q)) : "");
      const r=await fetch(url);
      const arr=await r.json();
      const feed=$("feed"); feed.innerHTML=""; let shown=0;
      for(const p of arr){
        const div=document.createElement("div"); div.className="post";
        div.innerHTML = `
          <div class="row"><strong>${p.author||"-"}</strong>
            <span class="small">${p.createdAt?new Date(p.createdAt).toLocaleString():""}</span></div>
          <div>${(p.text||"")}</div>
          ${p.imageUrl?`<div><img src="${p.imageUrl}" style="max-width:100%;border-radius:8px;margin-top:6px"></div>`:""}
          ${p.videoUrl?`<div><video controls src="${p.videoUrl}" style="max-width:100%;border-radius:8px;margin-top:6px"></video></div>`:""}
        `;
        feed.appendChild(div); shown++;
      }
      $("empty").style.display = shown ? "none" : "block";
    }catch(e){
      alert("AkÄ±ÅŸ hatasÄ±: "+e);
    }
  }

  $("btnPost").addEventListener("click", async ()=>{
    const text=$("postText").value.trim();
    const imageUrl=$("postImage")?.value.trim();
    const videoUrl=$("postVideo")?.value.trim();
    const isPrivate=$("postPrivate")?.checked || false;
    if(!text) return alert("Metin boÅŸ olamaz");
    const author = store.token || "Anonim";
    const r=await fetch(API+"/api/posts",{method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({author,text,imageUrl,videoUrl,private:isPrivate})});
    const j=await r.json();
    if(!r.ok) return alert(j.error||"PaylaÅŸÄ±m hatasÄ±");
    $("postText").value=""; if($("postImage")) $("postImage").value=""; if($("postVideo")) $("postVideo").value=""; if($("postPrivate")) $("postPrivate").checked=false;
    loadFeed();
  });

  // --- KZAsistan (sadece Llama-2-7B; fallback yok) ---
  let engine=null, lastAnswer="";
  async function ensureModel(){
    if (location.protocol !== "https:" && location.hostname !== "localhost"){
      $("httpsWarn").style.display = "block";
      throw new Error("HTTPS/localhost gerekli");
    }
    if (engine) return engine;
    $("ans").textContent = "â³ Llama yÃ¼kleniyor...";
    engine = await webllm.CreateMLCEngine("Llama-2-7b-chat-hf-q4f16_1", {
      initProgressCallback: (p) => {
        const pct = Math.round((p?.progress || 0) * 100);
        setBar(pct);
        $("ans").textContent = "ğŸ“¥ YÃ¼kleniyor: " + pct + "%";
      }
    });
    $("ans").textContent = "âœ… Llama hazÄ±r";
    setBar(100);
    return engine;
  }

  $("btnAsk").addEventListener("click", async ()=>{
    const q=$("ask").value.trim(); if(!q) return;
    try{
      const eng = await ensureModel();
      $("ans").textContent = "ğŸ’­ DÃ¼ÅŸÃ¼nÃ¼yor...";
      // webllm 0.2.x â€“ completions API
      const resp = await eng.chat.completions.create({ messages:[{role:"user",content:q}] });
      const txt = resp?.choices?.[0]?.message?.content || "(boÅŸ yanÄ±t)";
      $("ans").textContent = txt;
      lastAnswer = txt;
    }catch(e){
      $("ans").textContent = "âŒ Model yÃ¼klenemedi: " + e.message;
    }
  });

  $("btnAsistanToFeed").addEventListener("click", async ()=>{
    if(!lastAnswer) return alert("Ã–nce asistan cevap Ã¼retsin.");
    try{
      const r=await fetch(API+"/api/assistant/post",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({text:lastAnswer})});
      const j=await r.json();
      if(!j.ok) return alert(j.error||"Asistan yazamadÄ±");
      loadFeed();
      alert("Asistan akÄ±ÅŸa yazdÄ±.");
    }catch(e){
      alert("Hata: "+e);
    }
  });

  // ilk aÃ§Ä±lÄ±ÅŸta akÄ±ÅŸ
  loadFeed();
</script>
</body>
</html>
