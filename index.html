<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KZMedia + KZAsistan</title>
<script src="https://unpkg.com/@mlc-ai/web-llm/dist/index.js"></script>
<style>
  body{margin:0;font-family:sans-serif;background:#0b0c10;color:#eee}
  .header{padding:12px;background:#11131a;border-bottom:1px solid #222;display:flex;justify-content:space-between}
  .container{max-width:1000px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr 320px;gap:12px}
  .card{background:#11131a;padding:12px;border-radius:10px}
  input,textarea{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #333;background:#0e1016;color:#eee}
  button{padding:8px 12px;margin-top:8px;border:none;border-radius:6px;cursor:pointer;background:#4f8cff;color:#fff}
  .post{margin-top:10px;padding:10px;border:1px solid #333;border-radius:8px}
  #ans{white-space:pre-wrap;background:#222;padding:10px;border-radius:6px;margin-top:10px}
</style>
</head>
<body>
<header class="header">
  <strong>KZMedia</strong>
  <span>+ KZAsistan</span>
</header>

<main class="container">
  <section class="card">
    <h3>Giriş / Kayıt</h3>
    <input id="txtUser" placeholder="kullanıcı adı">
    <input id="txtPass" placeholder="şifre" type="password">
    <button id="btnRegister">Kayıt</button>
    <button id="btnLogin">Giriş</button>
    <hr>
    <div id="compose" style="display:none">
      <h3>Paylaş</h3>
      <textarea id="postText" rows="3"></textarea>
      <input id="postImage" placeholder="Resim URL">
      <input id="postVideo" placeholder="Video URL">
      <label><input id="postPrivate" type="checkbox">@KUZILER</label>
      <button id="btnPost">Paylaş</button>
      <button id="btnRefresh">Yenile</button>
    </div>
    <h3>Akış</h3>
    <div id="feed"></div>
  </section>

  <aside class="card">
    <h4>KZAsistan</h4>
    <button id="btnLoad">📥 Model İndir</button>
    <input id="ask" placeholder="Sor...">
    <button id="btnAsk">Sor</button>
    <div id="ans"></div>
  </aside>
</main>

<script>
const API="";
const $=id=>document.getElementById(id);
let token=null;

// Kayıt
$('btnRegister').onclick=async()=>{
  const u=$('txtUser').value,p=$('txtPass').value;
  const r=await fetch(API+'/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const j=await r.json(); alert(j.ok?"Kayıt OK":"Hata:"+j.error);
};

// Giriş
$('btnLogin').onclick=async()=>{
  const u=$('txtUser').value,p=$('txtPass').value;
  const r=await fetch(API+'/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const j=await r.json();
  if(j.ok){token=j.token;$('compose').style.display='block';loadFeed();}
  else alert(j.error);
};

// Post
$('btnPost').onclick=async()=>{
  const text=$('postText').value;
  const r=await fetch(API+'/api/posts',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({text})});
  if(r.ok){$('postText').value='';loadFeed();}
};

// Feed
async function loadFeed(){
  const r=await fetch(API+'/api/posts/feed',{headers:{'Authorization':'Bearer '+token}});
  const arr=await r.json();$('feed').innerHTML='';
  arr.forEach(p=>{
    const d=document.createElement('div');
    d.className='post';
    d.innerHTML=`<b>${p.author}</b>: ${p.text}`;
    $('feed').appendChild(d);
  });
}
$('btnRefresh').onclick=loadFeed;

// === KZAsistan ===
let engine=null;
$('btnLoad').onclick=async()=>{
  $('ans').textContent="⏳ Model indiriliyor...";
  engine=await webllm.CreateMLCEngine("Llama-2-7b-chat-hf-q4f16_1",{initProgressCallback:(p)=>{ $('ans').textContent="📥 "+Math.round(p.progress*100)+"%";}});
  $('ans').textContent="✅ Model hazır!";
};
$('btnAsk').onclick=async()=>{
  if(!engine) return alert("Önce modeli indir!");
  const q=$('ask').value;
  $('ans').textContent="💭 Düşünüyor...";
  const r=await engine.chat.completions.create({messages:[{role:"user",content:q}]});
  $('ans').textContent=r.choices[0].message.content;
};
</script>
</body>
</html>
