<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KZMedia â€¢ Tek Dosya (Yerel Demo)</title>
<style>
:root{--bg:#0b0c10;--card:#11131a;--text:#e8eaed;--muted:#a3a7b0;--primary:#4f8cff;--accent:#64d2ff;--danger:#ff5c74;--border:#212532}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.container{grid-template-columns:1fr 320px}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1016;color:var(--text);outline:none}
button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.small{font-size:13px;color:var(--muted)}
.feed .post{margin-top:12px;padding:12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.post .meta{display:flex;justify-content:space-between;align-items:center}
.post img,.post video{max-width:100%;border-radius:8px;margin-top:8px}
.tag{background:var(--primary);color:#fff;padding:3px 8px;border-radius:999px;font-size:12px;margin-left:8px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.notice{padding:8px;border-radius:8px;background:#122;color:#9fdf;margin-top:8px}
.admin-badge{background:#222;border-radius:6px;padding:4px 8px;font-size:12px;color:var(--accent)}
.row{display:flex;gap:8px;align-items:center;margin-top:4px}
.field-inline{flex:1}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
.small-muted{font-size:12px;color:var(--muted)}
.user-row button{padding:4px 8px;font-size:12px;}
</style>
</head>
<body>
<div class="header">
  <div style="font-weight:800">KZMedia</div>
  <div class="small-muted">Tam demo (yerel). Veriler localStorage'da.</div>
</div>
<main class="container">
  <!-- Sol: AkÄ±ÅŸ ve PaylaÅŸÄ±m -->
  <section class="card">
    <div id="topArea">
      <div id="authBox">
        <h3>GiriÅŸ / KayÄ±t</h3>
        <div class="row">
          <input id="txtUser" placeholder="KullanÄ±cÄ± adÄ± (boÅŸ olamaz)" class="field-inline">
          <input id="txtPass" placeholder="Åifre" class="field-inline" type="password">
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnRegister" class="btn-primary">KayÄ±t Ol</button>
          <button id="btnLogin">GiriÅŸ</button>
        </div>
        <div class="small-muted" style="margin-top:8px">
          Sahip kodu (owner key) yerel olarak <code>OWNER_CODE</code> ile kontrol edilir. VarsayÄ±lan: "0".
        </div>
      </div>
      <div id="composeBox" style="display:none;margin-top:12px">
        <h3>PaylaÅŸ</h3>
        <textarea id="postText" rows="3" placeholder="Ne paylaÅŸmak istersin?"></textarea>
        <input id="postImage" placeholder="Resim URL (opsiyonel)">
        <input id="postVideo" placeholder="Video URL (opsiyonel)">
        <label style="display:block;margin-top:6px">
          <input id="postPrivate" type="checkbox"> 
          <span class="small">@kuzilerÃ¶zel (yalnÄ±zca @KUZILER Ã¼yeleri gÃ¶rebilir)</span>
        </label>
        <div class="controls">
          <button id="btnPost" class="btn-primary">PaylaÅŸ</button>
          <button id="btnRefresh">Yenile</button>
        </div>
      </div>
    </div>
    <hr>
    <h3>AkÄ±ÅŸ</h3>
    <div id="feed" class="feed"></div>
    <div id="empty" class="notice" style="display:none">HenÃ¼z gÃ¶nderi yok.</div>
    <div class="footer">KZMedia â€¢ Yerel demo</div>
  </section>

  <!-- SaÄŸ: Profil / Admin / Reklam -->
  <aside class="card">
    <div>
      <div class="small">Åu anki kullanÄ±cÄ±: <strong id="meName">â€”</strong> <span id="meBadge"></span></div>
      <div class="small-muted" style="margin-top:6px">TakipÃ§i: <strong id="meFollowers">0</strong></div>
      <div style="margin-top:8px" id="authButtons"></div>
    </div>
    <hr>
    <div id="adminPanel" style="display:none">
      <h4>Admin Paneli</h4>
      <div class="small-muted">Burada adminler duyuru (ilan), kullanÄ±cÄ± rolleri ve takipÃ§i sayÄ±sÄ±nÄ± dÃ¼zenleyebilir. AyrÄ±ca kullanÄ±cÄ±larÄ± admin yapabilirsiniz.</div>
      <div style="margin-top:8px">
        <label>Duyuru / Ä°lan (tek tane)</label>
        <textarea id="adminAd" rows="3" placeholder="KÄ±sa ilan/duyuru"></textarea>
        <div style="margin-top:8px" class="row">
          <button id="btnSaveAd" class="btn-primary">Duyuruyu Kaydet</button>
          <button id="btnClearAd">Temizle</button>
        </div>
      </div>
      <hr>
      <div>
        <h4>KullanÄ±cÄ±larÄ± YÃ¶net</h4>
        <div id="userList"></div>
      </div>
      <hr>
      <div>
        <label>KullanÄ±cÄ± takipÃ§i sayÄ±sÄ±nÄ± deÄŸiÅŸtir</label>
        <div class="row" style="margin-top:6px">
          <input id="adminUserFollowers" placeholder="kullaniciadi" class="field-inline">
          <input id="adminFollowerCount" placeholder="yeni sayÄ±" style="width:90px">
        </div>
        <div style="margin-top:8px">
          <button id="btnSetFollowers" class="btn-primary">Uygula</button>
        </div>
      </div>
    </div>
    <div id="adBox" style="margin-top:12px"></div>
  </aside>
</main>

<script>
const OWNER_CODE = "0"; // owner kodu
let DATA = loadData();
const $ = id=>document.getElementById(id);

function loadData(){
  const raw = localStorage.getItem('KZMedia.data');
  if(!raw) return { users:{}, posts:[], ad:"" };
  try{ return JSON.parse(raw);}catch(e){return { users:{}, posts:[], ad:"" };}
}

function saveData(){ localStorage.setItem('KZMedia.data',JSON.stringify(DATA)); }
function setMe(name){
  if(!name){
    window._ME=null;
    $('meName').textContent='â€”';
    $('meBadge').textContent='';
    $('meFollowers').textContent='0';
  }else{
    window._ME={name};
    const u = DATA.users[name];
    const isAdmin = u.roles && u.roles.indexOf('ADMIN')>=0;
    const isK = u.roles && u.roles.indexOf('KUZILER')>=0;
    $('meName').textContent=name;
    $('meBadge').textContent= isAdmin ? ' <span class="admin-badge">ADMIN</span>' : (isK ? ' <span class="small-muted">@KUZILER</span>' : '');
    $('meFollowers').textContent=u.followers||0;
  }
  renderAuthUI();
  loadFeed();
  renderAd();
  addAuthButtons();
  renderUsers();
}

function renderAuthUI(){
  if(window._ME){ $('composeBox').style.display='block'; $('authBox').style.display='none'; }
  else { $('composeBox').style.display='none'; $('authBox').style.display='block'; }

  const meName = window._ME?.name;
  if(meName && DATA.users[meName] && DATA.users[meName].roles && DATA.users[meName].roles.indexOf('ADMIN')>=0){
    $('adminPanel').style.display='block';
  }else{
    $('adminPanel').style.display='none';
  }
}

// --- Register / Login
$('btnRegister').addEventListener('click',()=>{
  const name = $('txtUser').value.trim();
  const pass = $('txtPass').value;
  if(!name){ alert('KullanÄ±cÄ± adÄ± girin'); return;}
  if(DATA.users[name]){ alert('Bu kullanÄ±cÄ± adÄ± zaten var'); return;}
  DATA.users[name]={ pass:pass||'', roles:[], followers:0 };
  if(pass===OWNER_CODE){ DATA.users[name].roles.push('ADMIN'); DATA.users[name].roles.push('KUZILER'); }
  saveData();
  alert('KayÄ±t tamam. GiriÅŸ yapabilirsiniz.');
});

$('btnLogin').addEventListener('click',()=>{
  const name = $('txtUser').value.trim();
  const pass = $('txtPass').value;
  if(!name){ alert('KullanÄ±cÄ± adÄ± girin'); return;}
  const u = DATA.users[name];
  if(!u){ alert('KullanÄ±cÄ± bulunamadÄ±. KayÄ±t olun.'); return;}
  if(u.pass!==pass){ alert('Åifre yanlÄ±ÅŸ'); return;}
  setMe(name);
});

// logout / profil
function addAuthButtons(){
  const box=$('authButtons'); box.innerHTML='';
  if(window._ME){
    const btnLogout=document.createElement('button'); btnLogout.textContent='Ã‡Ä±kÄ±ÅŸ';
    btnLogout.onclick=()=>setMe(null);
    const btnProfile=document.createElement('button'); btnProfile.textContent='Profilim';
    btnProfile.onclick=()=>alert('Profil: '+window._ME.name);
    box.appendChild(btnProfile); box.appendChild(btnLogout);
  }
}

// --- Posts
$('btnPost').addEventListener('click',()=>{
  if(!window._ME){ alert('Ã–nce giriÅŸ yapÄ±n'); return;}
  const text = $('postText').value.trim();
  if(!text){ alert('Metin boÅŸ olamaz'); return;}
  const p={ id:Date.now().toString(36)+Math.random().toString(36).slice(2,8),
            author:window._ME.name,
            text,
            imageUrl:$('postImage').value.trim()||null,
            videoUrl:$('postVideo').value.trim()||null,
            private:!!$('postPrivate').checked,
            likes:0,
            createdAt:Date.now() };
  DATA.posts.push(p);
  saveData();
  $('postText').value=''; $('postImage').value=''; $('postVideo').value=''; $('postPrivate').checked=false;
  loadFeed();
});

function loadFeed(){
  const feed = $('feed'); feed.innerHTML='';
  const q = $('q')?.value.trim().toLowerCase()||'';
  const list = (DATA.posts||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  let shown=0;
  for(const p of list){
    if(p.private){
      const me=window._ME?DATA.users[window._ME.name]:null;
      const isMember = me && me.roles && me.roles.indexOf('KUZILER')>=0;
      if(!isMember && !(window._ME && window._ME.name===p.author)) continue;
    }
    if(q && !((p.text||'').toLowerCase().includes(q) || (p.author||'').toLowerCase().includes(q))) continue;
    const div=document.createElement('div'); div.className='post';
    const isAdmin = window._ME && DATA.users[window._ME.name] && DATA.users[window._ME.name].roles && DATA.users[window._ME.name].roles.indexOf('ADMIN')>=0;
    const canEdit = window._ME && (window._ME.name===p.author || isAdmin);
    const tag = (DATA.users[p.author] && DATA.users[p.author].roles && DATA.users[p.author].roles.indexOf('KUZILER')>=0) ? '<span class="tag">@KUZILER</span>':'';
    div.innerHTML = `<div class="meta"><div class="who">${escapeHtml(p.author)} ${tag}</div><div class="small">${new Date(p.createdAt).toLocaleString()}</div></div>
                     <div>${escapeHtml(p.text)}</div>
                     ${p.imageUrl?`<div><img src="${escapeHtml(p.imageUrl)}" alt=""></div>`:''}
                     ${p.videoUrl?`<div><video controls src="${escapeHtml(p.videoUrl)}"></video></div>`:''}
                     <div style="margin-top:8px" class="row">
                       <button class="btn-like">â¤ ${p.likes||0}</button>
                       ${canEdit?'<button class="btn-edit">DÃ¼zenle</button>':''}
                       ${canEdit?'<button class="btn-del">Sil</button>':''}
                     </div>`;
    feed.appendChild(div);
    shown++;
    div.querySelector('.btn-like')?.addEventListener('click',()=>{ p.likes=(p.likes||0)+1; saveData(); loadFeed(); });
    if(canEdit){
      div.querySelector('.btn-edit')?.addEventListener('click',()=>{ const newText=prompt('Yeni metin:',p.text); if(newText!==null){ p.text=newText; saveData(); loadFeed(); }});
      div.querySelector('.btn-del')?.addEventListener('click',()=>{ if(confirm('GÃ¶nderiyi silmek istiyor musunuz?')){ DATA.posts=DATA.posts.filter(x=>x.id!==p.id); saveData(); loadFeed(); }});
    }
  }
  $('empty').style.display=shown?'none':'block';
}

function escapeHtml(s=''){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);}

// --- Admin Actions
$('btnSaveAd')?.addEventListener('click',()=>{ if(!checkAdmin()) return; DATA.ad=$('adminAd').value.trim(); saveData(); renderAd(); alert('Duyuru kaydedildi'); });
$('btnClearAd')?.addEventListener('click',()=>{ if(!checkAdmin()) return; DATA.ad=''; saveData(); renderAd(); });

// --- Set followers
$('btnSetFollowers')?.addEventListener('click',()=>{
  if(!checkAdmin()) return;
  const name=$('adminUserFollowers').value.trim(); const cnt=parseInt($('adminFollowerCount').value);
  if(!name || !DATA.users[name]) return alert('KullanÄ±cÄ± bulunamadÄ±');
  if(Number.isNaN(cnt)) return alert('GeÃ§erli sayÄ± girin');
  DATA.users[name].followers=cnt; saveData(); alert('Ayar kaydedildi');
  if(window._ME && window._ME.name===name) setMe(name);
});

// --- Render ad
function renderAd(){
  const box=$('adBox'); box.innerHTML='';
  if(DATA.ad && DATA.ad.trim()){ const d=document.createElement('div'); d.className='notice'; d.textContent=DATA.ad; box.appendChild(d); }
}

// --- Check admin
function checkAdmin(){ const me=window._ME && DATA.users[window._ME.name]; if(!me || !me.roles || me.roles.indexOf('ADMIN')<0){ alert('Sadece adminler yapabilir'); return false;} return true;}

// --- Render users for admin panel
function renderUsers(){
  const list=$('userList'); if(!list) return;
  list.innerHTML='';
  for(const name in DATA.users){
    const u=DATA.users[name];
    const div=document.createElement('div'); div.className='row user-row';
    const isAdmin = u.roles && u.roles.indexOf('ADMIN')>=0;
    const displayName = isAdmin?name+'@ADMIN':name;
    div.innerHTML=`<span>${displayName}</span> <button class="btn-primary btn-make-admin">Admin Yap</button>`;
    div.querySelector('.btn-make-admin').addEventListener('click',()=>{
      if(!checkAdmin()) return;
      if(!u.roles) u.roles=[];
      if(u.roles.indexOf('ADMIN')<0) u.roles.push('ADMIN');
      saveData(); renderUsers(); alert(displayName+' artÄ±k admin!');
    });
    list.appendChild(div);
  }
}

// startup
(function startup(){
  if(!DATA.users['owner']) DATA.users['owner']={pass:OWNER_CODE,roles:['ADMIN','KUZILER'],followers:0};
  saveData();
  setMe(null);
})();
// KZMedia - PROD Backend (MongoDB Atlas, separate auth; bad-auth'a kesin Ã§Ã¶zÃ¼m)
// KullanÄ±m: Render ENV'ye ÅŸunlarÄ± ekle (tÄ±rnaksÄ±z, tek satÄ±r):
// MONGO_HOST=kzcluster.cjxpbq3.mongodb.net
// MONGO_USER=KZMedia             (DB Access'teki kullanÄ±cÄ± adÄ±; CASE-SENSITIVE!)
// MONGO_PASS=ParolanHarfRakam    (Ã¶neri: sadece harf+rakam; encode derdi yok)
// DB_NAME=kzmedia
// JWT_KEY=kzmedia-ProdSecret-2025!!   (uzun bir gizli anahtar)
// Not: MONGO_URL KULLANILMIYOR. (Varsa sil/boÅŸalt)
//
// Build: npm install
// Start: npm start

const express = require("express");
const mongoose = require("mongoose");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const helmet = require("helmet");
const cors = require("cors");
const rateLimit = require("express-rate-limit");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 8080;
const JWT_KEY =
  process.env.JWT_KEY ||
  "kzmedia_prod_f2d8c7f9c0a14a5ab2c4b8e9d1e3f5a7b9c2d4e6f8a0b1c2d3e4f5061728394".slice(
    0,
    64
  );

app.set("trust proxy", 1);
app.use(helmet({ contentSecurityPolicy: false }));
app.use(cors());
app.use(express.json({ limit: "1mb" }));

const authLimiter = rateLimit({ windowMs: 10 * 60 * 1000, max: 60 });
const apiLimiter = rateLimit({ windowMs: 60 * 1000, max: 120 });
app.use("/api/auth", authLimiter);
app.use("/api", apiLimiter);

/* ---------------- MONGO: separate auth (URI'ya user/pass gÃ¶mmeyiz) ---------------- */
const HOST = (process.env.MONGO_HOST || "").trim(); // Ã¶r: kzcluster.cjxpbq3.mongodb.net
const USER = (process.env.MONGO_USER || "").trim(); // Ã¶r: KZMedia  (CASE-SENSITIVE!)
const PASS = process.env.MONGO_PASS ?? ""; // dÃ¼z ÅŸifre (Ã¶neri: harf+rakam)
const DB = (process.env.DB_NAME || "kzmedia").trim();

if (!HOST || !USER || PASS === "") {
  console.error(
    "âŒ Mongo ENV eksik. Gerekli: MONGO_HOST, MONGO_USER, MONGO_PASS, DB_NAME"
  );
  process.exit(1);
}

const baseUri = `mongodb+srv://${HOST}/?retryWrites=true&w=majority`;

mongoose
  .connect(baseUri, {
    dbName: DB,
    user: USER,
    pass: PASS,
    authSource: "admin", // Atlas DB kullanÄ±cÄ±larÄ± admin DB'de tutulur
    authMechanism: "SCRAM-SHA-256",
    serverSelectionTimeoutMS: 15000,
  })
  .then(() => {
    console.log("âœ… MongoDB Atlas baÄŸlandÄ± (separate auth)");
  })
  .catch((err) => {
    console.error("âŒ MongoDB baÄŸlantÄ± hatasÄ±:", err.message);
    console.error(
      "â„¹ï¸ Kontrol: Database Access'te DB User (Project User deÄŸil), Username CASE doÄŸru, ÅŸifre doÄŸru, Network Access 0.0.0.0/0, host ve DB adÄ± doÄŸru."
    );
    process.exit(1);
  });

/* ---------------- MODELLER ---------------- */
const { Schema, model } = mongoose;

const userSchema = new Schema(
  {
    username: {
      type: String,
      unique: true,
      required: true,
      minlength: 3,
      maxlength: 24,
    },
    email: { type: String, unique: true, sparse: true },
    passwordHash: { type: String, required: true },
    roles: { type: [String], default: [] }, // ["ADMIN","KUZILER"]
    followers: { type: Number, default: 0 },
    meta: { type: Object, default: {} },
  },
  { timestamps: true }
);
const User = model("User", userSchema);

const postSchema = new Schema(
  {
    author: { type: Schema.Types.ObjectId, ref: "User", required: true },
    text: { type: String, required: true, maxlength: 500 },
    imageUrl: { type: String, default: "" },
    videoUrl: { type: String, default: "" },
    private: { type: Boolean, default: false }, // @KUZILER Ã¶zel
    likes: [{ type: Schema.Types.ObjectId, ref: "User" }],
  },
  { timestamps: true }
);
const Post = model("Post", postSchema);

/* ---------------- YARDIMCILAR ---------------- */
function signToken(userId) {
  return jwt.sign({ userId }, JWT_KEY, { expiresIn: "7d" });
}
function requireAuth(req, res, next) {
  const token = (req.headers.authorization || "").replace(/^Bearer\s+/i, "");
  if (!token) return res.status(401).json({ error: "Oturum gerekli" });
  try {
    const payload = jwt.verify(token, JWT_KEY);
    req.userId = payload.userId;
    next();
  } catch {
    return res.status(401).json({ error: "Token geÃ§ersiz" });
  }
}
async function isAdmin(userId) {
  const u = await User.findById(userId);
  return !!(u && u.roles && u.roles.includes("ADMIN"));
}
async function isKuziler(userId) {
  const u = await User.findById(userId);
  return !!(u && u.roles && u.roles.includes("KUZILER"));
}

/* ---------------- HEALTH & DIAG ---------------- */
app.get("/health", (req, res) =>
  res.json({ ok: true, db: mongoose.connection.readyState === 1 ? "up" : "down" })
);
app.get("/db/check", async (req, res) => {
  try {
    const state = mongoose.connection.readyState; // 0=d,1=c,2=ing,3=dising
    if (state !== 1) await mongoose.connection.asPromise();
    res.json({ ok: mongoose.connection.readyState === 1, state: mongoose.connection.readyState });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

/* ---------------- AUTH ---------------- */
app.post("/api/auth/register", async (req, res) => {
  try {
    let { username, email, password, ownerCode } = req.body || {};
    if (!username || !password)
      return res.status(400).json({ error: "Eksik alanlar" });
    username = String(username).trim();

    const exists = await User.findOne({ $or: [{ username }, { email }] });
    if (exists)
      return res
        .status(409)
        .json({ error: "KullanÄ±cÄ± adÄ± veya e-posta kullanÄ±mda" });

    const passwordHash = await bcrypt.hash(password, 10);
    const roles = ownerCode === "0" ? ["ADMIN", "KUZILER"] : [];

    const user = await User.create({ username, email, passwordHash, roles });
    res
      .status(201)
      .json({ id: user._id, username: user.username, roles: user.roles });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

app.post("/api/auth/login", async (req, res) => {
  try {
    const { usernameOrEmail, password } = req.body || {};
    if (!usernameOrEmail || !password)
      return res.status(400).json({ error: "Eksik alanlar" });

    const user = await User.findOne({
      $or: [{ username: usernameOrEmail }, { email: usernameOrEmail }],
    });
    if (!user) return res.status(401).json({ error: "KullanÄ±cÄ± bulunamadÄ±" });

    const ok = await bcrypt.compare(password, user.passwordHash);
    if (!ok) return res.status(401).json({ error: "Åifre hatalÄ±" });

    const token = signToken(user._id);
    res.json({
      token,
      user: {
        id: user._id,
        username: user.username,
        roles: user.roles,
        followers: user.followers,
      },
    });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

app.get("/api/auth/me", requireAuth, async (req, res) => {
  const u = await User.findById(req.userId).select("username roles followers");
  res.json(u);
});

/* ---------------- POSTS ---------------- */
app.post("/api/posts", requireAuth, async (req, res) => {
  try {
    const { text, imageUrl, videoUrl, private: isPrivate } = req.body || {};
    if (!text || !String(text).trim())
      return res.status(400).json({ error: "Metin gerekli" });

    const post = await Post.create({
      author: req.userId,
      text: String(text).trim(),
      imageUrl: imageUrl || "",
      videoUrl: videoUrl || "",
      private: !!isPrivate,
    });
    const populated = await post.populate("author", "username roles");
    res.status(201).json(populated);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

app.get("/api/posts/feed", requireAuth, async (req, res) => {
  try {
    const limit = Math.min(parseInt(req.query.limit) || 50, 100);
    const userIsK = await isKuziler(req.userId);

    const posts = await Post.find()
      .sort({ createdAt: -1 })
      .limit(limit)
      .populate("author", "username roles");

    const filtered = posts.filter(
      (p) =>
        !p.private || userIsK || String(p.author._id) === String(req.userId)
    );
    res.json(filtered);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

app.post("/api/posts/:id/like", requireAuth, async (req, res) => {
  try {
    const post = await Post.findById(req.params.id);
    if (!post) return res.status(404).json({ error: "GÃ¶nderi bulunamadÄ±" });

    const idx = post.likes.findIndex((u) => String(u) === String(req.userId));
    if (idx === -1) post.likes.push(req.userId);
    else post.likes.splice(idx, 1);

    await post.save();
    res.json({ likes: post.likes.length, liked: idx === -1 });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

app.delete("/api/posts/:id", requireAuth, async (req, res) => {
  try {
    const post = await Post.findById(req.params.id).populate("author", "_id");
    if (!post) return res.status(404).json({ error: "GÃ¶nderi bulunamadÄ±" });
    const isAuthor = String(post.author._id) === String(req.userId);
    const admin = await isAdmin(req.userId);
    if (!isAuthor && !admin) return res.status(403).json({ error: "Yetki yok" });

    await Post.deleteOne({ _id: post._id });
    res.json({ ok: true });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

/* ---------------- TROLL (sadece kursatomer @ KUZILER) ---------------- */
app.post("/api/troll/:username", requireAuth, async (req, res) => {
  try {
    const me = await User.findById(req.userId);
    if (!me || me.username !== "kursatomer" || !me.roles.includes("KUZILER")) {
      return res.status(403).json({ error: "Yetkin yok" });
    }
    const target = await User.findOne({ username: req.params.username });
    if (!target) return res.status(404).json({ error: "KullanÄ±cÄ± bulunamadÄ±" });

    target.followers = Number.POSITIVE_INFINITY;
    target.meta = target.meta || {};
    target.meta.trolledAt = Date.now();
    if (req.query.ban === "1") target.meta.banned = true;

    await target.save();
    res.json({
      ok: true,
      message: target.meta.banned
        ? `${target.username} trollendi ve banlandÄ± (âˆ).`
        : `${target.username} trollendi (âˆ).`,
    });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

/* ---------------- Statik (senin index.html) ---------------- */
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"));
});

/* ---------------- Start ---------------- */
app.listen(PORT, "0.0.0.0", () => {
  console.log(`ğŸš€ KZMedia API ayakta: http://localhost:${PORT}`);
});
</script>
</body>
</html>
